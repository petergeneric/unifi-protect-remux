<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:RemuxGui.ViewModels"
             xmlns:conv="using:RemuxGui.Converters"
             x:Class="RemuxGui.Views.LogView"
             x:DataType="vm:MainViewModel">

    <UserControl.Resources>
        <conv:LogLevelColorConverter x:Key="LogLevelColorConverter" />
    </UserControl.Resources>

    <UserControl.Styles>
        <Style Selector="Button.filter-pill">
            <Setter Property="Padding" Value="12,4" />
            <Setter Property="FontSize" Value="12" />
            <Setter Property="CornerRadius" Value="12" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="BorderBrush" Value="{DynamicResource SystemControlForegroundBaseMediumLowBrush}" />
            <Setter Property="Background" Value="Transparent" />
        </Style>
    </UserControl.Styles>

    <DockPanel>
        <!-- Top toolbar -->
        <Border DockPanel.Dock="Top" Padding="16,10">
            <DockPanel>
                <TextBlock Text="Log" FontSize="18" FontWeight="SemiBold"
                           VerticalAlignment="Center" />
                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" Spacing="8"
                            HorizontalAlignment="Right" VerticalAlignment="Center">
                    <Button Content="Clear" Command="{Binding ClearLogCommand}"
                            Padding="16,6" />
                    <Button Content="Export..." Click="OnExportLog"
                            Padding="16,6" />
                </StackPanel>
            </DockPanel>
        </Border>

        <!-- Active file filter banner -->
        <Border DockPanel.Dock="Top" Padding="16,6"
                BorderThickness="0,0,0,1"
                BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                IsVisible="{Binding LogFileFilterLabel, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
            <DockPanel>
                <Button DockPanel.Dock="Right" Content="Show all"
                        Command="{Binding ClearLogFileFilterCommand}"
                        Padding="10,3" FontSize="11"
                        VerticalAlignment="Center" />
                <StackPanel Orientation="Horizontal" Spacing="6" VerticalAlignment="Center">
                    <TextBlock Text="Filtered to file:"
                               FontSize="12"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                    <TextBlock Text="{Binding LogFileFilterLabel}"
                               FontSize="12" FontWeight="SemiBold" />
                </StackPanel>
            </DockPanel>
        </Border>

        <!-- Filter bar -->
        <Border DockPanel.Dock="Top" Padding="16,8"
                BorderThickness="0,0,0,1"
                BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}">
            <DockPanel>
                <!-- Search box on right -->
                <TextBox DockPanel.Dock="Right" Text="{Binding LogSearchText}"
                         Watermark="Search log..." Width="200"
                         FontSize="12" VerticalAlignment="Center" />

                <!-- Filter pills -->
                <StackPanel Orientation="Horizontal" Spacing="6">
                    <Button Classes="filter-pill"
                            Command="{Binding SetLogFilterCommand}"
                            CommandParameter="All">
                        <TextBlock Text="All" />
                    </Button>
                    <Button Classes="filter-pill"
                            Command="{Binding SetLogFilterCommand}"
                            CommandParameter="info">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <TextBlock Text="Info" />
                            <TextBlock FontSize="10" VerticalAlignment="Center"
                                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}">
                                <TextBlock.Text>
                                    <Binding Path="InfoCount" StringFormat="({0})" />
                                </TextBlock.Text>
                            </TextBlock>
                        </StackPanel>
                    </Button>
                    <Button Classes="filter-pill"
                            Command="{Binding SetLogFilterCommand}"
                            CommandParameter="warn">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <TextBlock Text="Warn" Foreground="#DCB432" />
                            <TextBlock FontSize="10" VerticalAlignment="Center"
                                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}">
                                <TextBlock.Text>
                                    <Binding Path="WarnCount" StringFormat="({0})" />
                                </TextBlock.Text>
                            </TextBlock>
                        </StackPanel>
                    </Button>
                    <Button Classes="filter-pill"
                            Command="{Binding SetLogFilterCommand}"
                            CommandParameter="error">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <TextBlock Text="Error" Foreground="#F05A5A" />
                            <TextBlock FontSize="10" VerticalAlignment="Center"
                                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}">
                                <TextBlock.Text>
                                    <Binding Path="ErrorCount" StringFormat="({0})" />
                                </TextBlock.Text>
                            </TextBlock>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </DockPanel>
        </Border>

        <!-- Status bar -->
        <Border DockPanel.Dock="Bottom" Padding="16,6"
                BorderThickness="0,1,0,0"
                BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}">
            <DockPanel>
                <TextBlock FontSize="11"
                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                           VerticalAlignment="Center">
                    <TextBlock.Text>
                        <MultiBinding StringFormat="{}{0} entries Â· {1} info, {2} warnings, {3} errors">
                            <Binding Path="LogLines.Count" />
                            <Binding Path="InfoCount" />
                            <Binding Path="WarnCount" />
                            <Binding Path="ErrorCount" />
                        </MultiBinding>
                    </TextBlock.Text>
                </TextBlock>
            </DockPanel>
        </Border>

        <!-- Log entries -->
        <Border Padding="0" Background="{DynamicResource SystemControlBackgroundBaseLowBrush}">
            <ScrollViewer x:Name="LogScrollViewer">
                <ItemsControl ItemsSource="{Binding FilteredLogLines}" Padding="8">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Grid ColumnDefinitions="62,36,*" Margin="0,1">
                                <TextBlock Grid.Column="0" Text="{Binding TimestampLabel}"
                                           FontFamily="Cascadia Mono, Consolas, Menlo, monospace"
                                           FontSize="11"
                                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                                <TextBlock Grid.Column="1"
                                           FontFamily="Cascadia Mono, Consolas, Menlo, monospace"
                                           FontSize="11"
                                           Foreground="{Binding Level, Converter={StaticResource LogLevelColorConverter}}">
                                    <TextBlock.Text>
                                        <Binding Path="Level" StringFormat="[{0}]" />
                                    </TextBlock.Text>
                                </TextBlock>
                                <TextBlock Grid.Column="2"
                                           FontFamily="Cascadia Mono, Consolas, Menlo, monospace"
                                           FontSize="11"
                                           TextWrapping="Wrap"
                                           Margin="4,0,0,0"
                                           Text="{Binding Message}" />
                            </Grid>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
        </Border>
    </DockPanel>
</UserControl>
