name: Release (macOS)

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Existing tag to attach assets to (leave empty for build-only test)"
        required: false
      sign:
        description: "Code sign and notarise (uncheck to test build logic only)"
        type: boolean
        default: true

permissions:
  contents: write
  checks: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-apple-darwin
            artifact: unifi-protect-remux-macos-aarch64
            rid: osx-arm64
            arch: aarch64
          - target: x86_64-apple-darwin
            artifact: unifi-protect-remux-macos-x86_64
            rid: osx-x64
            arch: x86_64

    name: ${{ matrix.artifact }}
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build deps
        run: brew install nasm pkg-config openssl brotli create-dmg

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest

      - name: Cache cargo registry and build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: release-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            release-${{ matrix.target }}-

      - name: Set up code signing
        id: codesign
        env:
          DEVELOPER_ID_CERT_P12: ${{ secrets.DEVELOPER_ID_CERT_P12 }}
          DEVELOPER_ID_CERT_PASSWORD: ${{ secrets.DEVELOPER_ID_CERT_PASSWORD }}
          APP_STORE_CONNECT_KEY_P8: ${{ secrets.APP_STORE_CONNECT_KEY_P8 }}
        run: |
          set -euo pipefail
          if [[ "${{ inputs.sign }}" == "false" ]]; then
            echo "Signing disabled via workflow input — will produce unsigned output"
            echo "CODESIGN_ENABLED=false" >> "$GITHUB_ENV"
            exit 0
          fi
          if [[ -z "${DEVELOPER_ID_CERT_P12:-}" ]]; then
            echo "No signing certificate configured — will produce unsigned output"
            echo "CODESIGN_ENABLED=false" >> "$GITHUB_ENV"
            exit 0
          fi

          echo "CODESIGN_ENABLED=true" >> "$GITHUB_ENV"

          # Create temporary keychain
          KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -base64 32)"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          CERT_PATH="$RUNNER_TEMP/certificate.p12"
          echo "$DEVELOPER_ID_CERT_P12" | base64 --decode > "$CERT_PATH"
          security import "$CERT_PATH" \
            -k "$KEYCHAIN_PATH" \
            -P "$DEVELOPER_ID_CERT_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security
          rm "$CERT_PATH"

          # Allow codesign to access the keychain without UI prompt
          security set-key-partition-list -S apple-tool:,apple:,codesign: \
            -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain-db

          # Extract signing identity
          echo "Available codesigning identities:"
          security find-identity -v -p codesigning "$KEYCHAIN_PATH" || true
          IDENTITY=$(security find-identity -v -p codesigning "$KEYCHAIN_PATH" \
            | grep "Developer ID Application" | head -1 | sed 's/.*"\(.*\)".*/\1/' || true)
          if [[ -z "$IDENTITY" ]]; then
            echo "ERROR: No 'Developer ID Application' identity found after import" >&2
            exit 1
          fi
          echo "Signing identity: $IDENTITY"
          echo "CODESIGN_IDENTITY=$IDENTITY" >> "$GITHUB_ENV"
          echo "SIGNING_KEYCHAIN=$KEYCHAIN_PATH" >> "$GITHUB_ENV"

          # Write App Store Connect API key for notarytool
          NOTARY_KEY_PATH="$RUNNER_TEMP/AuthKey.p8"
          echo "$APP_STORE_CONNECT_KEY_P8" > "$NOTARY_KEY_PATH"
          echo "NOTARY_KEY_PATH=$NOTARY_KEY_PATH" >> "$GITHUB_ENV"

      - name: Build release binaries
        run: cargo build --release --target ${{ matrix.target }}

      - name: Build C# GUI
        run: |
          mkdir -p "remux-gui-cs/RemuxGui/native/${{ matrix.rid }}"
          cp "target/${{ matrix.target }}/release/libremux_ffi.dylib" "remux-gui-cs/RemuxGui/native/${{ matrix.rid }}/"
          dotnet publish remux-gui-cs/RemuxGui/RemuxGui.csproj -c Release -r "${{ matrix.rid }}" --self-contained -o "publish/${{ matrix.rid }}"

      - name: Test
        run: cargo nextest run --release --target ${{ matrix.target }} --profile ci

      - name: Publish test report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Tests (${{ matrix.artifact }})
          path: target/nextest/ci/junit.xml
          reporter: java-junit

      - name: Package and sign
        env:
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          set -euo pipefail
          VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          APP_NAME="UBV Remux"

          # --- Stage CLI binaries ---
          echo "=== Staging CLI binaries ==="
          mkdir -p staging
          cp target/${{ matrix.target }}/release/remux staging/
          cp target/${{ matrix.target }}/release/ubv-info staging/
          cp target/${{ matrix.target }}/release/ubv-anonymise staging/

          # --- Create .app bundle ---
          echo "=== Creating .app bundle ==="
          mkdir -p staging-gui
          scripts/create-macos-app.sh "publish/${{ matrix.rid }}" staging-gui "$VERSION"
          APP_BUNDLE="staging-gui/${APP_NAME}.app"

          if [[ "$CODESIGN_ENABLED" == "true" ]]; then
            # --- Write entitlements ---
            echo "=== Writing entitlements ==="
            ENTITLEMENTS="$RUNNER_TEMP/entitlements.plist"
            cat > "$ENTITLEMENTS" <<'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>com.apple.security.cs.allow-jit</key>
              <true/>
              <key>com.apple.security.cs.allow-unsigned-executable-memory</key>
              <true/>
          </dict>
          </plist>
          PLIST

            # --- Sign CLI binaries ---
            echo "=== Signing CLI binaries ==="
            for bin in staging/*; do
              echo "  Signing $(basename "$bin")..."
              codesign --force --options runtime --sign "$CODESIGN_IDENTITY" \
                --keychain "$SIGNING_KEYCHAIN" --timestamp "$bin"
            done

            # --- Sign .app bundle ---
            echo "=== Signing .app bundle ==="
            echo "  Signing dylibs inside bundle..."
            find -L "$APP_BUNDLE/Contents/MacOS" -type f -name '*.dylib' | while read -r macho; do
              echo "    $(basename "$macho")"
              codesign --force --options runtime --sign "$CODESIGN_IDENTITY" \
                --keychain "$SIGNING_KEYCHAIN" --timestamp \
                --entitlements "$ENTITLEMENTS" "$macho"
            done

            echo "  Signing executables inside bundle..."
            find -L "$APP_BUNDLE/Contents/MacOS" -type f -perm +111 ! -name '*.dylib' | while read -r macho; do
              echo "    $(basename "$macho")"
              codesign --force --options runtime --sign "$CODESIGN_IDENTITY" \
                --keychain "$SIGNING_KEYCHAIN" --timestamp \
                --entitlements "$ENTITLEMENTS" "$macho"
            done

            echo "  Signing app bundle..."
            codesign --force --options runtime --sign "$CODESIGN_IDENTITY" \
              --keychain "$SIGNING_KEYCHAIN" --timestamp \
              --entitlements "$ENTITLEMENTS" \
              "$APP_BUNDLE"
            codesign --verify --verbose "$APP_BUNDLE"

            # --- Notarize CLI + .app together ---
            echo "=== Notarizing ==="
            NOTARIZE_DIR="$RUNNER_TEMP/notarize-staging"
            mkdir -p "$NOTARIZE_DIR/cli" "$NOTARIZE_DIR/gui"
            cp staging/* "$NOTARIZE_DIR/cli/"
            cp -a "$APP_BUNDLE" "$NOTARIZE_DIR/gui/"
            NOTARIZE_ZIP="$RUNNER_TEMP/notarize-submission.zip"
            ditto -c -k "$NOTARIZE_DIR" "$NOTARIZE_ZIP"

            xcrun notarytool submit "$NOTARIZE_ZIP" \
              --key "$NOTARY_KEY_PATH" \
              --key-id "$APP_STORE_CONNECT_KEY_ID" \
              --issuer "$APP_STORE_CONNECT_ISSUER_ID" \
              --wait

            echo "  Stapling .app..."
            xcrun stapler staple "$APP_BUNDLE"
          fi

          # --- Create CLI tarball ---
          echo "=== Creating CLI tarball ==="
          tar czf "${{ matrix.artifact }}.tar.gz" -C staging .

          if [[ "$CODESIGN_ENABLED" == "true" ]]; then
            # --- Create signed DMG ---
            echo "=== Creating DMG ==="
            VOLICON="assets/appicon.icns"
            DMG_STAGING="$RUNNER_TEMP/dmg-staging"
            mkdir -p "$DMG_STAGING"
            cp -a "$APP_BUNDLE" "$DMG_STAGING/"

            # create-dmg returns exit code 2 when the DMG was created successfully
            # but hdiutil couldn't cleanly eject the temp mount — treat that as success.
            create-dmg \
              --volname "$APP_NAME" \
              --volicon "$VOLICON" \
              --window-size 600 400 \
              --icon-size 128 \
              --icon "${APP_NAME}.app" 150 185 \
              --app-drop-link 450 185 \
              --hide-extension "${APP_NAME}.app" \
              --no-internet-enable \
              "gui-macos-${{ matrix.arch }}.dmg" \
              "$DMG_STAGING" \
              || test $? -eq 2

            echo "=== Signing DMG ==="
            codesign --force --sign "$CODESIGN_IDENTITY" \
              --keychain "$SIGNING_KEYCHAIN" --timestamp \
              "gui-macos-${{ matrix.arch }}.dmg"

            echo "=== Notarizing DMG ==="
            xcrun notarytool submit "gui-macos-${{ matrix.arch }}.dmg" \
              --key "$NOTARY_KEY_PATH" \
              --key-id "$APP_STORE_CONNECT_KEY_ID" \
              --issuer "$APP_STORE_CONNECT_ISSUER_ID" \
              --wait

            xcrun stapler staple "gui-macos-${{ matrix.arch }}.dmg"
            echo "GUI_OUTPUT=gui-macos-${{ matrix.arch }}.dmg" >> "$GITHUB_ENV"
            echo "GUI_ARTIFACT_NAME=gui-macos-${{ matrix.arch }}" >> "$GITHUB_ENV"
          else
            # --- Unsigned fallback: tarball ---
            echo "=== Creating unsigned GUI tarball ==="
            tar czf "gui-macos-unsigned-${{ matrix.arch }}.tar.gz" --exclude '*.dSYM' -C staging-gui .
            echo "GUI_OUTPUT=gui-macos-unsigned-${{ matrix.arch }}.tar.gz" >> "$GITHUB_ENV"
            echo "GUI_ARTIFACT_NAME=gui-macos-unsigned-${{ matrix.arch }}" >> "$GITHUB_ENV"
          fi

      - name: Upload artifact (CLI)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}.tar.gz

      - name: Upload artifact (GUI)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.GUI_ARTIFACT_NAME }}
          path: ${{ env.GUI_OUTPUT }}

      - name: Determine release tag
        id: tag
        run: echo "tag=${{ github.event.release.tag_name || inputs.tag }}" >> "$GITHUB_OUTPUT"

      - name: Upload release asset (CLI)
        if: steps.tag.outputs.tag != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload "${{ steps.tag.outputs.tag }}" "${{ matrix.artifact }}.tar.gz"

      - name: Upload release asset (GUI)
        if: steps.tag.outputs.tag != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload "${{ steps.tag.outputs.tag }}" "${{ env.GUI_OUTPUT }}"

      - name: Clean up signing credentials
        if: always()
        run: |
          if [[ -f "${SIGNING_KEYCHAIN:-}" ]]; then
            security delete-keychain "$SIGNING_KEYCHAIN" || true
          fi
          rm -f "${NOTARY_KEY_PATH:-}" || true
          rm -f "$RUNNER_TEMP/entitlements.plist" || true
