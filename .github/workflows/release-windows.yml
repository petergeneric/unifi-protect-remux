name: Release (Windows)

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Existing tag to attach assets to (leave empty for build-only test)"
        required: false

permissions:
  contents: write
  checks: write

jobs:
  build:
    name: cli-windows-x86_64
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install FFmpeg and LLVM
        shell: pwsh
        run: |
          # LLVM for bindgen
          choco install llvm --yes --no-progress
          echo "LIBCLANG_PATH=C:\Program Files\LLVM\bin" >> $env:GITHUB_ENV

          # Pre-built FFmpeg 8 shared libs
          Invoke-WebRequest -Uri "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-n8.0-latest-win64-lgpl-shared-8.0.zip" -OutFile ffmpeg.zip
          Expand-Archive ffmpeg.zip -DestinationPath .
          $ffmpegDir = (Resolve-Path "ffmpeg-n8.0-latest-win64-lgpl-shared-8.0").Path
          echo "FFMPEG_DIR=$ffmpegDir" >> $env:GITHUB_ENV
          echo "$ffmpegDir\bin" >> $env:GITHUB_PATH

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest

      - name: Cache cargo registry and build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: release-x86_64-pc-windows-msvc-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            release-x86_64-pc-windows-msvc-

      - name: Build release binaries
        run: cargo build --release --no-default-features --target x86_64-pc-windows-msvc

      - name: Build C# GUI
        shell: pwsh
        run: |
          $NativeDir = "remux-gui-cs/RemuxGui/native/win-x64"
          New-Item -ItemType Directory -Force $NativeDir
          Copy-Item "target/x86_64-pc-windows-msvc/release/remux_ffi.dll" $NativeDir
          Copy-Item "$env:FFMPEG_DIR\bin\*.dll" $NativeDir
          dotnet publish remux-gui-cs/RemuxGui/RemuxGui.csproj -c Release -r win-x64 --self-contained -o publish/win-x64

      - name: Test
        run: cargo nextest run --release --no-default-features --target x86_64-pc-windows-msvc --profile ci

      - name: Publish test report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Tests (cli-windows-x86_64)
          path: target/nextest/ci/junit.xml
          reporter: java-junit

      - name: Package
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force staging
          Copy-Item target/x86_64-pc-windows-msvc/release/remux.exe staging/
          Copy-Item target/x86_64-pc-windows-msvc/release/ubv-info.exe staging/
          Copy-Item target/x86_64-pc-windows-msvc/release/ubv-anonymise.exe staging/
          # Bundle FFmpeg DLLs so users don't need a separate FFmpeg install
          Copy-Item "$env:FFMPEG_DIR\bin\*.dll" staging/
          Compress-Archive -Path staging/* -DestinationPath cli-windows-x86_64.zip

          # Add GUI to staging for the NSIS installer
          New-Item -ItemType Directory -Force staging/RemuxGui
          Copy-Item -Recurse publish/win-x64/* staging/RemuxGui/

      - name: Build NSIS installer
        shell: pwsh
        run: |
          choco install nsis --yes --no-progress
          $nsisDir = "${env:ProgramFiles(x86)}\NSIS"
          Expand-Archive installer\nsis-plugins\EnVar_plugin.zip -DestinationPath $nsisDir
          $version = (Select-String -Path Cargo.toml -Pattern '^version\s*=\s*"(.+)"' | Select-Object -First 1).Matches.Groups[1].Value
          $stagingDir = (Resolve-Path staging).Path
          & "$nsisDir\makensis.exe" /DSTAGING_DIR=$stagingDir /DVERSION=$version installer\windows.nsi
          Move-Item installer\cli-windows-x86_64-setup.exe gui-unsigned-windows-x86_64.exe

      - name: Upload artifact (zip)
        uses: actions/upload-artifact@v4
        with:
          name: cli-windows-x86_64
          path: cli-windows-x86_64.zip

      - name: Upload artifact (GUI installer)
        uses: actions/upload-artifact@v4
        with:
          name: gui-unsigned-windows-x86_64
          path: gui-unsigned-windows-x86_64.exe

      - name: Determine release tag
        id: tag
        shell: bash
        run: echo "tag=${{ github.event.release.tag_name || inputs.tag }}" >> "$GITHUB_OUTPUT"

      - name: Upload release asset (zip)
        if: steps.tag.outputs.tag != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: gh release upload "${{ steps.tag.outputs.tag }}" cli-windows-x86_64.zip

      - name: Upload release asset (GUI installer)
        if: steps.tag.outputs.tag != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: gh release upload "${{ steps.tag.outputs.tag }}" gui-unsigned-windows-x86_64.exe
